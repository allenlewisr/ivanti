name: Create Entra ID Group and Add Users

on:
  workflow_dispatch:
    inputs:
      group_name:
        description: "The display name of the Entra ID group to create"
        required: true
        type: string
      group_description:
        description: "The description of the Entra ID group"
        required: false
        type: string
      mail_nickname:
        description: "The mail nickname for the group (defaults to group_name if not provided)"
        required: false
        type: string
      users_to_add:
        description: "User Principal Names (UPNs) or Object IDs to add to the group (comma-separated or one per line)"
        required: false
        type: string
      group_type:
        description: "The type of group to create"
        type: choice
        default: "Security"
        options:
          - Security
          - Microsoft365
        required: true
      mail_enabled:
        description: "Should the group be mail-enabled?"
        type: boolean
        default: false
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  manage-entra-group:
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          allow-no-subscriptions: true

      - name: Create Entra ID Group
        id: create-group
        run: |
          echo "Creating Entra ID group: ${{ github.event.inputs.group_name }}"
          
          # Set mail nickname (use group_name if not provided)
          MAIL_NICKNAME="${{ github.event.inputs.mail_nickname }}"
          if [[ -z "$MAIL_NICKNAME" ]]; then
            # Remove spaces and special characters for mail nickname
            MAIL_NICKNAME=$(echo "${{ github.event.inputs.group_name }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g')
          fi
          
          # Set group description
          DESCRIPTION="${{ github.event.inputs.group_description }}"
          if [[ -z "$DESCRIPTION" ]]; then
            DESCRIPTION="Entra ID group: ${{ github.event.inputs.group_name }}"
          fi
          
          # Determine group types
          if [[ "${{ github.event.inputs.group_type }}" == "Microsoft365" ]]; then
            GROUP_TYPES="Unified"
            SECURITY_ENABLED="false"
          else
            GROUP_TYPES=""
            SECURITY_ENABLED="true"
          fi
          
          # Check if group already exists
          echo "Checking if group '${{ github.event.inputs.group_name }}' already exists..."
          EXISTING_GROUP=$(az ad group list --filter "displayName eq '${{ github.event.inputs.group_name }}'" --query "[0].id" -o tsv)
          
          if [[ -n "$EXISTING_GROUP" ]]; then
            echo "Group '${{ github.event.inputs.group_name }}' already exists with Object ID: $EXISTING_GROUP"
            echo "GROUP_ID=$EXISTING_GROUP" >> $GITHUB_OUTPUT
          else
            echo "Group '${{ github.event.inputs.group_name }}' does not exist. Creating..."
            
            # Build the create command
            if [[ -z "$GROUP_TYPES" ]]; then
              # Security group
              GROUP_ID=$(az ad group create \
                --display-name "${{ github.event.inputs.group_name }}" \
                --mail-nickname "$MAIL_NICKNAME" \
                --description "$DESCRIPTION" \
                --query "id" -o tsv)
            else
              # Microsoft 365 group
              GROUP_ID=$(az ad group create \
                --display-name "${{ github.event.inputs.group_name }}" \
                --mail-nickname "$MAIL_NICKNAME" \
                --description "$DESCRIPTION" \
                --mail-enabled ${{ github.event.inputs.mail_enabled }} \
                --security-enabled false \
                --query "id" -o tsv)
            fi
            
            if [[ -n "$GROUP_ID" ]]; then
              echo "Group created successfully with Object ID: $GROUP_ID"
              echo "GROUP_ID=$GROUP_ID" >> $GITHUB_OUTPUT
            else
              echo "Failed to create group."
              exit 1
            fi
          fi

      - name: Add Users to Group
        if: ${{ github.event.inputs.users_to_add != '' }}
        run: |
          echo "Adding users to group: ${{ github.event.inputs.group_name }}"
          GROUP_ID="${{ steps.create-group.outputs.GROUP_ID }}"
          
          if [[ -z "$GROUP_ID" ]]; then
            echo "Error: GROUP_ID is empty. Cannot add users."
            exit 1
          fi
          
          # Parse users from input (handle both comma-separated and newline-separated)
          USERS_INPUT="${{ github.event.inputs.users_to_add }}"
          
          # Replace newlines with commas and normalize
          USERS=$(echo "$USERS_INPUT" | tr '\n' ',' | tr -s ',' | sed 's/^,//;s/,$//')
          
          # Convert to array
          IFS=',' read -ra USER_ARRAY <<< "$USERS"
          
          # Add each user to the group
          for USER in "${USER_ARRAY[@]}"; do
            # Trim whitespace
            USER=$(echo "$USER" | xargs)
            
            if [[ -z "$USER" ]]; then
              continue
            fi
            
            echo "Processing user: $USER"
            
            # Try to get user object ID (handle both UPN and Object ID)
            if [[ "$USER" =~ ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$ ]]; then
              # Already an Object ID
              USER_ID="$USER"
              echo "Using Object ID: $USER_ID"
            else
              # Assume it's a UPN, get the Object ID
              USER_ID=$(az ad user show --id "$USER" --query "id" -o tsv 2>/dev/null)
              
              if [[ -z "$USER_ID" ]]; then
                echo "Warning: User '$USER' not found. Skipping."
                continue
              fi
              
              echo "Found user with Object ID: $USER_ID"
            fi
            
            # Check if user is already a member
            IS_MEMBER=$(az ad group member check --group "$GROUP_ID" --member-id "$USER_ID" --query "value" -o tsv)
            
            if [[ "$IS_MEMBER" == "true" ]]; then
              echo "User '$USER' is already a member of the group. Skipping."
            else
              echo "Adding user '$USER' to the group..."
              
              if az ad group member add --group "$GROUP_ID" --member-id "$USER_ID"; then
                echo "Successfully added user '$USER' to the group."
              else
                echo "Failed to add user '$USER' to the group."
                exit 1
              fi
            fi
          done
          
          echo "Finished processing users."

      - name: Display Group Information
        run: |
          echo "Group Details:"
          az ad group show --group "${{ steps.create-group.outputs.GROUP_ID }}" --query "{DisplayName:displayName, ObjectId:id, Description:description, MailNickname:mailNickname, MailEnabled:mailEnabled, SecurityEnabled:securityEnabled}" -o table
          
          echo ""
          echo "Group Members:"
          az ad group member list --group "${{ steps.create-group.outputs.GROUP_ID }}" --query "[].{DisplayName:displayName, UserPrincipalName:userPrincipalName, ObjectId:id}" -o table

